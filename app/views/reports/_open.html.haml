
-# TODO @awdorsett - refactor code to remove "open" with more appropriate variable name
.report.open
  .row
    .rp_report_status.status
      -# TODO @awdorsett - better way to do expired
      - if open.expired?
        %del Em aberto
      - else
        Em aberto

      .rp_report_options
        -# TODO @awdorsett - are reports verified before they're eliminated?
        - if open.isVerified == "t"
          = image_tag 'icons/reports icon/check.png', :width => 25, :height => 25, :style => "float:right;"
        - elsif open.isVerified == "f"
          = image_tag 'icons/reports icon/x.png', :width => 25, :height => 25, :style => "float:right;"
        - else
          - if !open.expired? and open.elimination_type
            - if @current_user.role == "verificador" or @current_user.role == "admin" or @current_user.role == "coordenador"
              = link_to (image_tag 'icons/reports icon/x.png', :width => 25, :height => 25), problem_neighborhood_reports_path(@neighborhood, :id => open.id), method: :post, :style => "float:right;"
              = link_to (image_tag 'icons/reports icon/check.png', :width => 25, :height => 25), verify_neighborhood_reports_path(@neighborhood, :id => open.id), method: :post, :style => "float:right;"

        - if open.sms_incomplete?
          .span{style: "margin-top:3px; margin-right:10px;"}
            Torpedo

        - else

          - if not open.expired?
            - if open.elimination_type
              .countdown.countdownHolder.timer
              .span.countdown_label
                Tempo restante
                -# TODO @awdorsett - move JS out of view
                :javascript
                  var newYear = new Date(#{open.expire_date.strftime("%s").to_i * 1000});
                  $(".countdown").countdown({until: newYear, format: 'HMS', compact: 'true'});

          - else
            .span.time_expired
              Tempo expirado

  .row.address_row
    .span6.address
      - if open.sms_incomplete?
        %h4= open.report
      - else
        %h4= open.complete_address

    .span2
      - if open.location.latitude and open.location.longitude
        = link_to "Ache no mapa", "#", id: "mapa_#{open.id}", class: "mapa", data: { latitude: "#{open.location.latitude}", longitude: "#{open.location.longitude}"}

  .row{style: "margin-top:7px;"}

    -#before picture
    .span2.rp_before_photo
      =image_tag open.before_photo(:medium)

    -#report description
    .span5{style: "margin-top:9px;"}
      %h3.report_label Descrição da localização:
      .description #{open.report}

      -# TODO @awdorsett - need to figure out the process of handling SMS
      -#- else
      -#  - if !open.sms_incomplete?
      -#    = text_area_tag("report_description", open.report, style: "width:430px;")

      -# TODO @awdorsett - when will current_user be nil?
      - if @current_user != nil
        .row
          .span7

            -#elimination type
            %h3.report_label Tipo de foco:
            = open.elimination_type

            -#form to enter in elimination method and after photo
            .eliminate_prompt{:style => "margin-top:5px;"}
              = form_for(:eliminate, :url => {:controller => "reports", :neighborhood_id => @neighborhood.id, :action => "update", :html => {:autocomplete => "off", :multipart => false}}, :method=>:put) do |f|
                = hidden_field_tag 'report_id', open.id

                - if open.sms_incomplete?
                  = link_to "Completar o foco", edit_neighborhood_report_path(@neighborhood, open), class: "btn btn-info", style: "width:408px;background-color:#60BB50;background-image:-webkit-linear-gradient(top, #60BB50, #60BB50);border-color:#60BB50 #60BB50 #60BB50;margin-bottom:10px;"

                -# TODO @awdorsett - need to consider sms no being complete?
                %h3.report_label Método de eliminação:
                =select_tag "elimination_method", options_for_select(elimination_selection(open.elimination_type).collect{|p| [p[:display],p[:name]]}, open.elimination_method), :prompt=>open.method_prompt, :id=>"method_selection", :class=>"elimination_methods"

                -# TODO @awdorsett - why are we using selected_elimination_method instead of select tag? related to JS code?
                = hidden_field_tag "selected_elimination_method"

                -#stores location, used if location was not obtainable when creating report
                = hidden_field_tag "latitude"
                = hidden_field_tag "longitude"

                -# TODO @awdorsett - what is this used for?
                :javascript
                  $(".selectpicker").selectpicker();

                -#after photo
                - if open.after_photo_file_size
                  .rp_report_people
                    Foto carregada:
                    = link_to "#{open.after_photo_file_name}", open.after_photo.url, :class => "user"

                -# TODO @awdorsett - give user the option to upload a replacement image?
                %h3.report_label Carregue uma foto do foco eliminado:
                = f.file_field :after_photo, :disabled => (open.after_photo_file_size or open.expired?)

                %br
                = submit_tag "Enviar!",:onclick=>"update_location_coordinates(#{open.location.to_json},event);",:class=>'report_submission', :disabled => ((@current_user.role == "verificador" or @current_user.role == "visitante") or open.expired? or open.isVerified == "f" or open.sms_incomplete?)


                -# Submission status, show name and date of person who submitted, eliminated, and verified
                .row.rp_report_people{style: "width:430px;"}

                  -# site reported by
                  - if open.elimination_type and open.reporter_id
                    Marcado por:
                    =link_to open.reporter_name + " " + open.strftime_with(:created_at), user_path(open.reporter), :class => "user"
                    %br

                  -# site verified by
                  - if open.isVerified == "t" and open.verifier_id
                    Verificado por:
                    = link_to open.verifier_name + " " + open.strftime_with(:created_at), user_path(open.verifier), :class => "user"
                    %br
                  -# problem with site verification
                  - elsif open.isVerified == "f" and open.verifier_id
                    %p{:style => "color:red;font-weight:bold;margin-top:10px;"}
                      Problema no foco marcado. Entre em contato conosco.

    .row
      .rp_report_options
        -# delete report option for owner and admins
        -# TODO @awdorsett - removed elimination_type == nil, double check if that's okay
        - if @current_user.admin? or open.reporter == @current_user
          =link_to (image_tag 'icons/reports icon/delete2.png', :id=>'user_report_delete'), neighborhood_report_path(@neighborhood, open), :confirm => "Você tem certeza?", :method => :delete, :style => "margin-right:5px;"
