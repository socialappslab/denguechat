var postListCtrl = function ($scope, $http, session) {
  var pathName = window.location.pathname;
  var ajax   = $http.get("/api/v0/" + pathName + "/posts.json");

  ajax.success(function(data) {
    $scope.posts = data.posts;
  });
  ajax.error(function(response) {
    $("#newsfeed .error-message").show();
  })
  ajax.then(function() {
    $("#newsfeed .loading-spinner").hide();
  })

  $scope.updateLikesCounter = function(post)
  {
    // TODO: Use Rails routes.
    var ajax = $http.post("/api/v0/posts/" + post.id + "/like", {"count": post.likes_count});
    ajax.success(function(data) {
      post.likes_count = data.count;

      // TODO: Think of a better way to represent likeColor outside of the Post model.
      if (data.liked)
        post.likeColor = "#3498db"
      else
        post.likeColor = "#8899a6"

    })
  }
};

var feedItemDirective = function(){
  return {
    restrict: "E", // Restrict the template to being called only when using <feed-item> HTML element.
    scope: {
      "post": "=" // This is equivalent to the "=post" scope.
    },
    templateUrl: "<%= asset_path('posts/show.html') %>"
  }
}

var commentDirective = function () {
  return {
    restrict: "E", // Restrict the template to being called only when using <post-comment> HTML element.
    scope: {
      "comment": "=" // This is equivalent to the "=comment" scope.
    },
    templateUrl: "<%= asset_path('comments/show.html') %>"
  }
};

// We use inline annotation to declare services in order to bypass
// errors when JS gets minified:
// https://docs.angularjs.org/tutorial/step_05
var postController = angular.module('dengueChatApp');
postController.controller("DCPostListCtrl", ["$scope", "$http", "session", postListCtrl]);

// Define the directives on the controller.
postController.directive("postComment", commentDirective);
postController.directive("feedItem", feedItemDirective);
