var postListCtrl = function ($scope, $http) {
  var pathName = window.location.pathname;
  var ajax   = $http.get("/api/v0" + pathName + "/posts.json");

  ajax.success(function(data) {
    $scope.posts = data.posts;
  });
  ajax.error(function(response) {
    $("#newsfeed .error-message").show();
    $("#newsfeed .loading-spinner").hide();
  });
  ajax.then(function(response) {
    $("#newsfeed .loading-spinner").hide();
  });

  $scope.updateLikesCounter = function(post)
  {
    // TODO: Use Rails routes.
    var ajax = $http.post("/api/v0/posts/" + post.id + "/like", {"count": post.likes_count});
    ajax.success(function(data) {
      post.likes_count = data.count;

      // TODO: Think of a better way to represent likeColor outside of the Post model.
      if (data.liked)
        post.likeColor = "#3498db"
      else
        post.likeColor = "#8899a6"
    })
  }

  $scope.updateCommentLikesCounter = function(comment)
  {
    // TODO: Use Rails routes.
    var ajax = $http.post("/api/v0/comments/" + comment.id + "/like", {"count": comment.likes_count});
    ajax.success(function(data) {
      comment.likes_count = data.count;

      // TODO: Think of a better way to represent likeColor outside of the Post model.
      if (data.liked)
        comment.likeColor = "#3498db"
      else
        comment.likeColor = "#8899a6"
    })
  }
};

// NOTE: We're not specifying isolate scope here since we'll *ONLY* use this
// directive on the PostListCtrl. As such, we will use 'post' and all other
// methods from the parent scope (e.g. the controller). If we ever introduce
// scope here, we have to make sure that the ng-click events bubble up to the
// parent scope.
var feedItemDirective = function(){
  return {
    restrict: "E", // Restrict the template to being called only when using <feed-item> HTML element.
    templateUrl: "<%= asset_path('posts/show.html') %>"
  }
}

var commentDirective = function () {
  return {
    restrict: "E", // Restrict the template to being called only when using <post-comment> HTML element.
    // NOTE: We're not specifying isolate scope here since we'll *ONLY* use this
    // directive on the PostListCtrl. As such, we will use 'post' and all other
    // methods from the parent scope (e.g. the controller). If we ever introduce
    // scope here, we have to make sure that the ng-click events bubble up to the
    // parent scope.
    // scope: {
    //   "comment": "=" // This is equivalent to the "=comment" scope.
    // },
    templateUrl: "<%= asset_path('comments/show.html') %>"
  }
};

// We use inline annotation to declare services in order to bypass
// errors when JS gets minified:
// https://docs.angularjs.org/tutorial/step_05
var postController = angular.module('dengueChatApp');
postController.controller("DCPostListCtrl", ["$scope", "$http", postListCtrl]);

// Define the directives on the controller.
postController.directive("postComment", commentDirective);
postController.directive("feedItem", feedItemDirective);
